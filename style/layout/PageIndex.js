import { ContentBase } from "./ContentBase.js";
import { parseMarkdown } from "./MarkdownParser.js";

export class PageIndex {
    constructor () {
        this.json = null;
        this.isRoot = false;
        this.parentTitle = null;
        this.children = [];
    }

    async init () {
    // Determine root: layout.js is at {root}/style/layout/layout.js
        const rootDir = new URL("../..", import.meta.url).href;
        const pageDir = new URL("./", window.location.href).href;
        this.isRoot = (pageDir === rootDir);

        // Fetch _index.json, fall back to _index.md
        try {
            const resp = await fetch("./_index.json");
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            this.json = await resp.json();
        } catch (e) {
            try {
                const mdResp = await fetch("./_index.md");
                if (!mdResp.ok) throw new Error(`HTTP ${mdResp.status}`);
                const mdText = await mdResp.text();
                this.json = parseMarkdown(mdText);
            } catch (e2) {
                console.error("Failed to load _index.json or _index.md:", e2);
                return;
            }
        }

        // Derive title from json or folder name
        const pathSegments = window.location.pathname
            .split("/").filter(s => s.length > 0);
        if (pathSegments.length && pathSegments[pathSegments.length - 1].includes(".")) {
            pathSegments.pop(); // remove filename like index.html
        }
        const folderName = pathSegments.length > 0
            ? decodeURIComponent(pathSegments[pathSegments.length - 1])
            : "";
        this.pageTitle = this.json.title || folderName || "Untitled";
        this.topTitle = this.json.topTitle || "UndreamedOf";

        // Check for back-link override via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        this.backUrl = urlParams.get("back") || null;
        this.backTitle = null;

        // Fetch parent metadata for back-link and inherited topTitle
        if (!this.isRoot) {
            let parentJson = null;

            // If back URL is provided, fetch its metadata for the title
            if (this.backUrl) {
                const backDir = this.backUrl.replace(/\/[^/]*$/, "/");
                try {
                    const resp = await fetch(`${backDir}_index.json`);
                    if (resp.ok) {
                        const json = await resp.json();
                        this.backTitle = json.title || null;
                    }
                } catch (e) { /* fall back */ }
                if (!this.backTitle) {
                    try {
                        const resp = await fetch(`${backDir}_index.md`);
                        if (resp.ok) {
                            const json = parseMarkdown(await resp.text());
                            this.backTitle = json.title || null;
                        }
                    } catch (e) { /* fall back */ }
                }
            }

            try {
                const parentResp = await fetch("../_index.json");
                if (parentResp.ok) {
                    parentJson = await parentResp.json();
                    this.parentTitle = parentJson.title || null;
                }
            } catch (e) { /* fall back */ }

            if (!this.parentTitle) {
                try {
                    const parentMd = await fetch("../_index.md");
                    if (parentMd.ok) {
                        const mdText = await parentMd.text();
                        parentJson = parseMarkdown(mdText);
                        this.parentTitle = parentJson.title || null;
                    }
                } catch (e) { /* fall back */ }
            }

            // Inherit topTitle by walking up the directory tree
            if (!this.json.topTitle) {
                if (parentJson && parentJson.topTitle) {
                    this.topTitle = parentJson.topTitle;
                } else {
                    let depth = 2;
                    const maxDepth = pathSegments.length + 1;
                    while (depth <= maxDepth) {
                        const prefix = "../".repeat(depth);
                        try {
                            const resp = await fetch(`${prefix}_index.json`);
                            if (resp.ok) {
                                const json = await resp.json();
                                if (json.topTitle) { this.topTitle = json.topTitle; break; }
                            }
                        } catch (e) { /* continue */ }
                        depth++;
                    }
                }
            }

            if (!this.parentTitle) {
                const parentSegments = [...pathSegments];
                parentSegments.pop();
                this.parentTitle = parentSegments.length > 0
                    ? decodeURIComponent(parentSegments[parentSegments.length - 1])
                    : "Home";
            }
        }

        // Create content children
        if (Array.isArray(this.json.content)) {
            this.children = this.json.content.map(c => ContentBase.fromJson(c, 0));
        }

        // Resolve (async fetches)
        await Promise.all(this.children.map(c => c.resolve()));

        // Render
        this.render();
    }

    render () {
        const page = document.querySelector(".page");
        if (!page) return;

        // Header
        let headerHtml = '<div class="header">';
        if (this.isRoot) {
            headerHtml += `<h1>${this.pageTitle}</h1>`;
            headerHtml += `<div class="brand">${this.topTitle}</div>`;
        } else {
            const backHref = this.backUrl || "../index.html";
            const backLabel = this.backTitle || this.parentTitle;
            headerHtml += "<div>";
            headerHtml += `<h1>${this.pageTitle}</h1>`;
            headerHtml += `<a class="back-link" href="${backHref}">&larr; ${backLabel}</a>`;
            headerHtml += "</div>";
            headerHtml += `<a class="brand" href="${backHref}">${this.topTitle}</a>`;
        }
        headerHtml += "</div>";

        // Intro
        let introHtml = "";
        if (this.json.subtitle) {
            introHtml = `<p class="intro">${this.json.subtitle}</p>`;
        }

        // Content
        const contentHtml = this.children.map(c => c.computeHtml()).join("");

        if (this.json.pageLayout) {
            page.classList.add(`page-${this.json.pageLayout}`);
        }

        page.innerHTML = headerHtml + introHtml + contentHtml;

        // Post-render hooks
        this.children.forEach(c => c.postRender(page));

        // Document title
        if (this.isRoot) {
            document.title = this.topTitle;
        } else {
            document.title = `${this.pageTitle} \u2013 ${this.topTitle}`;
        }
    }
}
